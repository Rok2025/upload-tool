# 上传与传输效率提升方案

为了确保微服务大包（如 `infra`, `eng` 等）在“开发机 -> 1.50 -> B 节点”链路上的极速传输，本项目将着重实施以下技术方案：

## 1. 前端至 1.50 服务器 (HTTP 链路优化)

### 1.1 分片上传 (Chunked Upload)
- **技术要点**：在 Web 端利用 `Blob.slice()` 将大文件切分为固定大小（建议 5MB-10MB）的数据块。
- **优势**：并发请求，提升带宽利用率；单块失败无损整体，仅需重传失败片。

### 1.2 断点续传 (Resumable Upload)
- **技术要点**：上传前计算文件指纹（MD5）。后端记录已上传的分片索引。
- **优势**：网络波动、关闭浏览器后重新打开可秒速恢复进度。

### 1.3 秒传 (File Fingerprinting)
- **技术要点**：如果数据库中已存在相同 Hash 的文件版本，直接在服务端建立引用，跳过物理上传。

## 2. 1.50 至 B 节点 (跨机分发优化)

### 2.1 差异传输 (Rsync-like Delta)
- **技术要点**：通过 SSH 远程对比目标机现有包与新包的差异块，仅传输变更字节。
- **优势**：针对微服务代码微调场景，传输量可降低 90%。

### 2.2 流式分发驱动 (Streaming Transfer)
- **技术要点**：利用 Node.js `fs.createReadStream` 配合 `ssh2` 的 `sftp.createWriteStream`。
- **优势**：1.50 无需等待文件写入磁盘完毕即可开始向下透传，降低本地磁盘 I/O 延迟。

### 2.3 开启 SSH 内部压缩
- **技术要点**：在 SSH 连接配置中设置 `compress: true`。
- **优势**：在跨公网（如华为云）环境下，对文本类数据（静态资源、日志）有极高的传输收益。

## 3. 架构建议
- **并发推送**：支持同时向多个目标 B 节点发起部署，利用异步特性消除排队等待。
- **健康检查预收敛**：在包传输过程中预先执行目标机的磁盘空间清理和旧包轮转，最大化重叠操作。
