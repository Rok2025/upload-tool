# 项目发布包上传及自动化部署工具实施计划

## 目标说明
设计并实现一个集“发布包上传”、“自动化部署”、“运行日志查看”于一体的工具。该工具需支持：
- 中心化中转与分发：开发人员上传至中转服务器 (1.50 Windows)，再由中转服务器分发至目标 Linux 测试服务器 (如华为云)。
- 级联备份机制：中转服务器保留 7 天备份，目标服务器保留近期备份（3 天）。
- 跨平台部署：支持从 Windows 控制台远程操作 Linux (华为云等) 环境。
- 运行日志：支持通过中转服务器透传或直接连接目标机实时查看日志。

## 方案设计

### 1. 系统架构
采用 **中心控制台 (1.50) + 多目标节点 (Linux Servers)** 的模式。

- **Web 控制台 (部署于 1.50 Windows)**: 
  - 核心存储：接收开发人员上传的资源包并存放在指定卷。
  - 安全隔离：作为唯一具备 SSH 访问目标机 B 权限的跳转中心，开发人员无需也不具备直连 B 节点的权限。
  - 分发逻辑：负责将资源包通过 SCP 或 SSH 流分片分发至各目标测试服务器。
- **目标服务器 (Linux/华为云)**:
  - 真正对外提供业务服务的环境。
  - 执行具体的 Linux 命令进行发布（备份、解压、重启）。
- **自动化执行层**:
  - `Node.js` 控制台驱动跨平台的 SSH 指令执行。
- **日志采集器**:
  - 通过远程文件流（Tail -f 风格）实时读取目标服务器上的日志文件。

### 2. 技术栈
- **前端控制台**: Next.js (React) + Element Plus (Tailwind-compatible styles) + Lucide Icons.
- **后端服务**: Node.js (Next.js API Routes).
- **远程操作**: `ssh2` (Node.js 库) 用于与 Windows Server 通讯。
- **数据库**: MySQL (公司内部标准数据库，用于项目配置、服务器信息、发布记录)。
- **部署脚本**: Shell Script (在 Linux 目标机器 B 上执行备份与重启)。

## 提议的变更

### [Component] 控制台 Web 应用
#### [IMPLEMENTED] `src/app`
- ✅ 登录验证：JWT 会话管理，独立的 `users` 表维护开发者账号及密码（bcrypt 加密存储）。
- ✅ 登出功能：顶部栏「退出登录」按钮，清除会话 Cookie。
- ✅ 用户管理：用户 CRUD API (`/api/users`)，角色管理（admin/developer/viewer）。
- ✅ 权限系统：项目级部署权限控制 (`user_project_permissions` 表 + `/api/permissions` API)。
- ✅ 权限中间件：`src/lib/permissions.ts` 提供权限检查函数。
- ✅ 动态仪表盘：从数据库获取项目/模块/环境统计，展示今日发布次数。
- ✅ 项目配置管理：左侧 Tab 菜单（部署环境/项目配置）+ 右侧内容区布局。
- ✅ 侧边栏导航：带图标的菜单项，根据当前路由自动高亮。
- ✅ 实时日志：通过 SSE + SSH `tail -f` 实现远程日志流推送。
- 🔲 用户管理 UI：前端页面展示用户列表、分配权限（待实现）。

### [Component] 部署执行逻辑
#### [NEW] `packages/deploy-core`
- **中转分发模块**: 实现 `upload-to-1.50 -> archive-at-1.50 -> distribute-to-B`。
- **目标执行模块 (Linux)**:
  - SSH 连接 Linux 节点。
  - 执行 Shell 脚本：实现“安全替换”。不是直接删除旧包，而是通过 `mv` 重命名进行版本轮转（如 `app.jar` -> `app.jar.bak_timestamp`）。
  - 执行 `backup_and_clean.sh`：自动清理超过 3 天的旧备份。
  - 自动化流：`分发包 -> B 节点重命名备份 -> 停止服务 -> 替换新包并命名为标准运行名 -> 启动 -> 存活性校验`。

### [Component] 配置与数据存储
#### [NEW] `Database Schema (MySQL)`
- `projects`: 存储项目名、Git/模块信息。
- `environments`: 存储测试服务器 IP、**AES 加密存储的凭证 (Encrypted Credentials)**、基准路径、服务管理命令。
- `deploy_logs`: 存储每次发布的历史纪录。

## 验证计划

### 自动化测试
- 模拟 SSH 服务器进行部署流程压力测试。
- 校验文件上传完整性。

### 手动验证
- 在测试机 (1.50) 上配置 OpenSSH 服务的连通性。
- 演示完整微服务发布流程：
  1. 上传 `frontend` 编译后的静态资源包。
  2. 依次发布 `gateway`, `system`, `infra`, `eng` 等后端模块的 Jar 包。
- 验证发布权限：测试未授权用户是否无法触碰特定模块。
- 在界面实时查看各模块的控制台日志。

## 开发关键节点与技术要点

### 1. 关键节点 (Milestones)
- **M1: 基础骨架搭建** (Day 1-2): 
  - Next.js 项目初始化 + MySQL 库表初始化。
  - 核心上传 API 实现（支持大包分块）。
- **M2: 部署引擎与跨机分发** (Day 3-4): 
  - SSH2 跨平台通讯模块（Windows 控制台 -> Linux 目标机）。
  - 实现“SCP 分发 -> 远程 Shell 执行”的自动化链路。
  - 编写 Linux 端备份与滚动清理脚本。
- **M3: 用户与权限系统** (Day 5): 
  - 简单登录逻辑。
  - 模块级发布权限控制（数据库级别隔离）。
- **M4: 实时日志与 UI 抛光** (Day 6-7): 
  - 基于 SSH 的日志流推送实现（WebSocket/Server-Sent Events）。
  - Dashboard 仪表盘与发布状态实时更新。

### 2. 技术实现要点 (Technical Key Points)
- **跨平台 SSH 协同**: 
  - 控制台 (Windows 1.50) 通过 `ssh2` 驱动 Linux (B 节点) 执行 `tar`, `mv`, `systemctl` 等命令。
- **级联备份策略**: 
  - **1.50 端**: 存档最近 **7 天** 的历史上传包，超期自动清理。
  - **B 节点端**: 维护一个 `backups/` 目录，通过脚本保留最近 **3** 天的包，超期自动删除。
- **大包分发逻辑**: 
  - 传输链路：开发机 -> 1.50 (HTTP POST) -> B 节点 (SCP/Stream)。
  - 利用 Linux 环境的 `rsync`（若有）或 `scp` 保证分发的高可靠性。
- **非侵入式日志查看**: 
  - 通过 `ssh` 远程执行 `tail -f` 捕获 stdout，实时推送到 Web UI，无需在 B 节点安装额外 Agent。
- **发布审计与回滚**: 
  - 记录每次发布的版本。若 B 节点服务异常，可一键触发布脚本从 B 节点本地备份中快速恢复最近版本。

## 潜在风险与设计规备 (Risk Analysis)

| 风险点 | 影响 | 规避措施 |
| :--- | :--- | :--- |
| **部署原子性** | 替换包途中网络中断导致服务挂死 | 采用“安全替换”策略：先通过 `mv` 重命名备份，再传输新包，随时可快速改名恢复。 |
| **凭证泄露** | 数据库泄露导致目标机失控 | 对 SSH 密码/密钥进行 **AES 对称加密存储**，后端动态解密使用。 |
| **磁盘撑爆** | 频繁发布导致空间不足 | 强制执行 **1.50(7天) / B节点(3天)** 自动清理规则。 |
| **并发冲突** | 两人同时发布导致状态混乱 | 后端逻辑中引入 **发布互斥锁**，针对同一模块的任务需排队。 |
| **脚本换行符** | Windows 编辑的脚本在 Linux 报错 | 下发脚本前强制进行二进制流转换，确保为 `LF` 换行。 |

## 用户评审要求
1. **网络白名单**: 1.50 (Windows) 到 B 节点 (Linux) 的端口 22 (SSH) 是否已连通？
2. **目标机权限**: 控制台连接 B 节点使用的 SSH 账号是否具备操作目标路径及重启服务的 `sudo` 权限？
3. **备份天数**: 目标服务器 B 上的备份保留 **3** 天。
